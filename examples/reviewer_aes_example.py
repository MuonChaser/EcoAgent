#!/usr/bin/env python3
"""
Reviewer Agent + AES è¯„åˆ†ç³»ç»Ÿå®Œæ•´ç¤ºä¾‹

æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ ReviewerAgent è¿›è¡Œè®ºæ–‡è¯„å®¡ï¼ŒåŒ…æ‹¬ï¼š
1. LLM å®šæ€§è¯„å®¡
2. AES è‡ªåŠ¨è¯„åˆ†ï¼ˆåŸºäºä¼ ç»Ÿ NLPï¼‰
3. ç»¼åˆè¯„åˆ†ç»“æœåˆ†æ
"""

import sys
from pathlib import Path

# æ·»åŠ é¡¹ç›®æ ¹ç›®å½•åˆ°è·¯å¾„
project_root = Path(__file__).parent.parent
sys.path.insert(0, str(project_root))

from loguru import logger
from agents import ReviewerAgent

# é…ç½®æ—¥å¿—
logger.remove()
logger.add(
    sys.stderr,
    format="<green>{time:HH:mm:ss}</green> | <level>{level: <8}</level> | {message}",
    level="INFO"
)


def test_reviewer_basic():
    """åŸºç¡€å®¡ç¨¿åŠŸèƒ½æµ‹è¯•"""
    print("\n" + "=" * 70)
    print("æµ‹è¯•1: åŸºç¡€å®¡ç¨¿åŠŸèƒ½ï¼ˆä»… LLMï¼‰")
    print("=" * 70)

    # åˆå§‹åŒ–å®¡ç¨¿äººï¼ˆç¦ç”¨ AES ä»¥å¿«é€Ÿæµ‹è¯•ï¼‰
    reviewer = ReviewerAgent(enable_aes=False)

    # å‡†å¤‡è¾“å…¥æ•°æ®
    input_data = {
        "research_topic": "æ•°å­—åŒ–è½¬å‹å¯¹ä¼ä¸šåˆ›æ–°ç»©æ•ˆçš„å½±å“",
        "variable_system": """
        æ ¸å¿ƒå˜é‡ï¼š
        - X (è§£é‡Šå˜é‡): æ•°å­—åŒ–è½¬å‹ç¨‹åº¦
        - Y (è¢«è§£é‡Šå˜é‡): ä¼ä¸šåˆ›æ–°ç»©æ•ˆ
        - Z1 (ä¸­ä»‹å˜é‡): ç»„ç»‡å­¦ä¹ èƒ½åŠ›
        - Z2 (è°ƒèŠ‚å˜é‡): ç¯å¢ƒåŠ¨æ€æ€§
        """,
        "theory_framework": """
        ç†è®ºæ¡†æ¶åŸºäºï¼š
        1. èµ„æºåŸºç¡€ç†è®º (RBV)
        2. ç»„ç»‡å­¦ä¹ ç†è®º
        3. åŠ¨æ€èƒ½åŠ›ç†è®º
        """,
        "model_design": """
        åŸºå‡†æ¨¡å‹ï¼š
        Y_it = Î± + Î²â‚X_it + Î³Controls_it + Î¼_i + Î»_t + Îµ_it

        ä½¿ç”¨åŒå‘å›ºå®šæ•ˆåº”æ¨¡å‹æ§åˆ¶ä¸ªä½“å’Œæ—¶é—´æ•ˆåº”
        """,
        "data_analysis": """
        æ ·æœ¬ï¼š2015-2022å¹´ä¸Šå¸‚å…¬å¸æ•°æ®ï¼Œ2156ä¸ªè§‚æµ‹å€¼
        åŸºå‡†å›å½’ç³»æ•°ï¼šÎ²â‚ = 0.218*** (p<0.01)
        RÂ² = 0.623
        ä¸­ä»‹æ•ˆåº”å æ¯”ï¼š62%
        """,
        "final_report": """
        æœ¬æ–‡ç ”ç©¶æ•°å­—åŒ–è½¬å‹å¯¹ä¼ä¸šåˆ›æ–°ç»©æ•ˆçš„å½±å“ã€‚
        åŸºäº2015-2022å¹´ä¸Šå¸‚å…¬å¸æ•°æ®çš„å®è¯åˆ†æå‘ç°ï¼š

        1. æ•°å­—åŒ–è½¬å‹æ˜¾è‘—ä¿ƒè¿›ä¼ä¸šåˆ›æ–°ç»©æ•ˆï¼ˆÎ²=0.218, p<0.01ï¼‰
        2. ç»„ç»‡å­¦ä¹ èƒ½åŠ›èµ·éƒ¨åˆ†ä¸­ä»‹ä½œç”¨ï¼ˆä¸­ä»‹æ•ˆåº”62%ï¼‰
        3. ç¯å¢ƒåŠ¨æ€æ€§æ­£å‘è°ƒèŠ‚æ•°å­—åŒ–è½¬å‹çš„åˆ›æ–°æ•ˆåº”

        æœ¬ç ”ç©¶ä¸ºä¼ä¸šæ•°å­—åŒ–æˆ˜ç•¥æä¾›äº†å®è¯ä¾æ®ã€‚
        """
    }

    print("\næ­£åœ¨æ‰§è¡Œå®¡ç¨¿ï¼ˆä»… LLM å®šæ€§è¯„å®¡ï¼‰...")
    result = reviewer.run(input_data)

    print(f"\nâœ… å®¡ç¨¿å®Œæˆ")
    print(f"ç ”ç©¶ä¸»é¢˜: {result.get('research_topic', 'N/A')}")
    print(f"AES è¯„åˆ†: {'å·²å¯ç”¨' if result.get('aes_enabled') else 'æœªå¯ç”¨'}")


def test_reviewer_with_aes():
    """å¸¦ AES è¯„åˆ†çš„å®Œæ•´å®¡ç¨¿æµ‹è¯•"""
    print("\n" + "=" * 70)
    print("æµ‹è¯•2: å®Œæ•´å®¡ç¨¿æµç¨‹ï¼ˆLLM + AESï¼‰")
    print("=" * 70)

    # åˆå§‹åŒ–å®¡ç¨¿äººï¼ˆå¯ç”¨ AESï¼‰
    reviewer = ReviewerAgent(enable_aes=True)

    # å‡†å¤‡æ›´å®Œæ•´çš„è®ºæ–‡å†…å®¹
    paper_content = """
    æ•°å­—åŒ–è½¬å‹å¯¹ä¼ä¸šåˆ›æ–°ç»©æ•ˆçš„å½±å“ç ”ç©¶
    â€”â€”åŸºäºç»„ç»‡å­¦ä¹ èƒ½åŠ›çš„ä¸­ä»‹æ•ˆåº”åˆ†æ

    ä¸€ã€å¼•è¨€
    éšç€æ•°å­—ç»æµçš„å¿«é€Ÿå‘å±•ï¼Œä¼ä¸šæ•°å­—åŒ–è½¬å‹å·²æˆä¸ºæå‡ç«äº‰åŠ›çš„å…³é”®æˆ˜ç•¥ã€‚
    æœ¬æ–‡æ—¨åœ¨æ¢è®¨æ•°å­—åŒ–è½¬å‹å¯¹ä¼ä¸šåˆ›æ–°ç»©æ•ˆçš„å½±å“æœºåˆ¶ã€‚

    äºŒã€æ–‡çŒ®ç»¼è¿°ä¸ç ”ç©¶å‡è®¾
    å·²æœ‰ç ”ç©¶è¡¨æ˜ï¼Œæ•°å­—åŒ–è½¬å‹èƒ½å¤Ÿæ˜¾è‘—æå‡ä¼ä¸šåˆ›æ–°èƒ½åŠ›ï¼ˆå¼ ä¸‰å’Œæå››ï¼Œ2020ï¼›Smith et al., 2019ï¼‰ã€‚
    ç„¶è€Œï¼Œç°æœ‰æ–‡çŒ®å¯¹ä¸­ä»‹æœºåˆ¶çš„æ¢è®¨ä¸è¶³ï¼Œå°¤å…¶æ˜¯ç»„ç»‡å­¦ä¹ èƒ½åŠ›çš„ä½œç”¨å°šæœªå¾—åˆ°å……åˆ†éªŒè¯ã€‚

    åŸºäºèµ„æºåŸºç¡€ç†è®ºå’Œç»„ç»‡å­¦ä¹ ç†è®ºï¼Œæœ¬æ–‡æå‡ºä»¥ä¸‹å‡è®¾ï¼š

    å‡è®¾H1ï¼šæ•°å­—åŒ–è½¬å‹æ­£å‘å½±å“ä¼ä¸šåˆ›æ–°ç»©æ•ˆã€‚
    åŸºäºèµ„æºåŸºç¡€ç†è®ºï¼Œæ•°å­—æŠ€æœ¯ä½œä¸ºä¸€ç§é‡è¦çš„æˆ˜ç•¥èµ„æºï¼Œèƒ½å¤Ÿæå‡ä¼ä¸šçš„åˆ›æ–°èƒ½åŠ›ã€‚

    å‡è®¾H2ï¼šç»„ç»‡å­¦ä¹ èƒ½åŠ›åœ¨æ•°å­—åŒ–è½¬å‹ä¸åˆ›æ–°ç»©æ•ˆä¹‹é—´èµ·ä¸­ä»‹ä½œç”¨ã€‚
    æ ¹æ®ç»„ç»‡å­¦ä¹ ç†è®ºï¼Œæ•°å­—åŒ–è½¬å‹é€šè¿‡ä¿ƒè¿›çŸ¥è¯†è·å–å’Œè½¬åŒ–ï¼Œé—´æ¥æå‡åˆ›æ–°ç»©æ•ˆã€‚

    å‡è®¾H3ï¼šç¯å¢ƒåŠ¨æ€æ€§æ­£å‘è°ƒèŠ‚æ•°å­—åŒ–è½¬å‹å¯¹åˆ›æ–°ç»©æ•ˆçš„å½±å“ã€‚
    åœ¨é«˜åŠ¨æ€ç¯å¢ƒä¸­ï¼Œä¼ä¸šå¯¹æ•°å­—æŠ€æœ¯çš„éœ€æ±‚æ›´å¼ºï¼Œè½¬å‹æ•ˆæœæ›´æ˜¾è‘—ï¼ˆWang et al., 2021ï¼‰ã€‚

    ä¸‰ã€ç ”ç©¶è®¾è®¡

    3.1 æ ·æœ¬ä¸æ•°æ®
    æœ¬æ–‡ä½¿ç”¨2015-2022å¹´ä¸­å›½Aè‚¡ä¸Šå¸‚å…¬å¸æ•°æ®ï¼Œå…±2156ä¸ªè§‚æµ‹å€¼ã€‚
    æ•°æ®æ¥æºäºCSMARæ•°æ®åº“å’Œä¼ä¸šå¹´æŠ¥æ–‡æœ¬åˆ†æã€‚
    æ ·æœ¬çš„æè¿°æ€§ç»Ÿè®¡æ˜¾ç¤ºï¼Œå¹³å‡åˆ›æ–°ç»©æ•ˆä¸º12.47ï¼Œæ ‡å‡†å·®ä¸º0.83ã€‚

    3.2 å˜é‡æµ‹é‡
    è¢«è§£é‡Šå˜é‡ï¼ˆYï¼‰ï¼šä¼ä¸šåˆ›æ–°ç»©æ•ˆï¼Œä½¿ç”¨ä¸“åˆ©ç”³è¯·æ•°é‡çš„å¯¹æ•°å€¼è¡¡é‡ã€‚
    æ ¸å¿ƒè§£é‡Šå˜é‡ï¼ˆXï¼‰ï¼šæ•°å­—åŒ–è½¬å‹ç¨‹åº¦ï¼Œé€šè¿‡å¹´æŠ¥æ–‡æœ¬åˆ†ææ„å»ºæŒ‡æ•°ã€‚
    ä¸­ä»‹å˜é‡ï¼ˆZ1ï¼‰ï¼šç»„ç»‡å­¦ä¹ èƒ½åŠ›ï¼Œé‡‡ç”¨ç ”å‘æŠ•å…¥å¼ºåº¦å’ŒäººåŠ›èµ„æœ¬æŒ‡æ ‡åˆæˆã€‚
    è°ƒèŠ‚å˜é‡ï¼ˆZ2ï¼‰ï¼šç¯å¢ƒåŠ¨æ€æ€§ï¼Œä½¿ç”¨è¡Œä¸šé”€å”®é¢æ ‡å‡†å·®è¡¡é‡ã€‚
    æ§åˆ¶å˜é‡åŒ…æ‹¬ï¼šä¼ä¸šè§„æ¨¡ã€å¹´é¾„ã€è´¢åŠ¡æ æ†ã€æ‰€æœ‰åˆ¶ç±»å‹ç­‰ã€‚

    3.3 æ¨¡å‹è®¾å®š
    åŸºå‡†æ¨¡å‹é‡‡ç”¨åŒå‘å›ºå®šæ•ˆåº”æ¨¡å‹ï¼š
    Y_it = Î± + Î²â‚X_it + Î³Controls_it + Î¼_i + Î»_t + Îµ_it

    å…¶ä¸­ï¼ŒÎ¼_i ä¸ºä¼ä¸šå›ºå®šæ•ˆåº”ï¼ŒÎ»_t ä¸ºå¹´ä»½å›ºå®šæ•ˆåº”ã€‚

    å››ã€å®è¯ç»“æœ

    4.1 åŸºå‡†å›å½’
    è¡¨1æŠ¥å‘Šäº†åŸºå‡†å›å½’ç»“æœã€‚æ•°å­—åŒ–è½¬å‹çš„ç³»æ•°ä¸º0.218ï¼Œåœ¨1%æ°´å¹³ä¸Šæ˜¾è‘—ï¼ˆt=5.67, p<0.01ï¼‰ã€‚
    è¿™è¡¨æ˜æ•°å­—åŒ–è½¬å‹æ¯æå‡1ä¸ªæ ‡å‡†å·®ï¼Œä¼ä¸šåˆ›æ–°ç»©æ•ˆæå‡21.8%ã€‚
    æ¨¡å‹çš„RÂ²ä¸º0.623ï¼Œè¡¨æ˜è§£é‡ŠåŠ›è¾ƒå¼ºã€‚
    æ§åˆ¶å˜é‡æ–¹é¢ï¼Œä¼ä¸šè§„æ¨¡ï¼ˆç³»æ•°=0.15, p<0.05ï¼‰å’Œç ”å‘å¼ºåº¦ï¼ˆç³»æ•°=0.32, p<0.01ï¼‰å‡æ˜¾è‘—ä¸ºæ­£ã€‚

    4.2 ç¨³å¥æ€§æ£€éªŒ
    ä¸ºæ£€éªŒç»“æœçš„ç¨³å¥æ€§ï¼Œæœ¬æ–‡è¿›è¡Œäº†ä»¥ä¸‹æ£€éªŒï¼š
    ï¼ˆ1ï¼‰æ›¿æ¢è¢«è§£é‡Šå˜é‡ï¼šä½¿ç”¨å‘æ˜ä¸“åˆ©æ•°é‡ï¼Œç³»æ•°ä»ä¸º0.203ï¼ˆp<0.01ï¼‰ã€‚
    ï¼ˆ2ï¼‰æ”¹å˜æ ·æœ¬åŒºé—´ï¼šå‰”é™¤2020å¹´ç–«æƒ…å½±å“ï¼Œç³»æ•°ä¸º0.225ï¼ˆp<0.01ï¼‰ã€‚
    ï¼ˆ3ï¼‰æ›¿æ¢æ¨¡å‹ï¼šä½¿ç”¨å·¥å…·å˜é‡æ³•ï¼ˆIVï¼‰ï¼Œä¸¤é˜¶æ®µå›å½’ç³»æ•°ä¸º0.241ï¼ˆp<0.01ï¼‰ã€‚
    ä¸Šè¿°æ£€éªŒå‡æ”¯æŒåŸºå‡†ç»“æœçš„ç¨³å¥æ€§ã€‚

    4.3 ä¸­ä»‹æ•ˆåº”æ£€éªŒ
    é‡‡ç”¨Baronå’ŒKennyï¼ˆ1986ï¼‰çš„ä¸‰æ­¥æ³•æ£€éªŒä¸­ä»‹æ•ˆåº”ã€‚
    ç¬¬ä¸€æ­¥ï¼šXå¯¹Yçš„å½±å“æ˜¾è‘—ï¼ˆÎ²=0.218, p<0.01ï¼‰ã€‚
    ç¬¬äºŒæ­¥ï¼šXå¯¹Z1çš„å½±å“æ˜¾è‘—ï¼ˆÎ²=0.173, p<0.01ï¼‰ã€‚
    ç¬¬ä¸‰æ­¥ï¼šåŒæ—¶çº³å…¥Xå’ŒZ1åï¼ŒZ1å¯¹Yæ˜¾è‘—ï¼ˆÎ²=0.0029, p<0.01ï¼‰ï¼ŒXçš„ç³»æ•°é™ä¸º0.081ï¼ˆp<0.01ï¼‰ã€‚
    Sobelæ£€éªŒzå€¼ä¸º2.54ï¼ˆp<0.05ï¼‰ï¼ŒBootstrapç½®ä¿¡åŒºé—´ä¸º[0.00013, 0.00090]ï¼Œä¸åŒ…å«0ã€‚
    ä¸­ä»‹æ•ˆåº”å æ€»æ•ˆåº”çš„æ¯”ä¾‹ä¸º62%ï¼Œè¡¨æ˜ç»„ç»‡å­¦ä¹ èƒ½åŠ›æ˜¯é‡è¦çš„ä¸­ä»‹æœºåˆ¶ã€‚

    4.4 å¼‚è´¨æ€§åˆ†æ
    æŒ‰è¡Œä¸šæŠ€æœ¯æ°´å¹³åˆ†ç»„ï¼Œå‘ç°ï¼š
    - é«˜æŠ€æœ¯è¡Œä¸šï¼šÎ²=0.35ï¼ˆp<0.01ï¼‰
    - ä½æŠ€æœ¯è¡Œä¸šï¼šÎ²=0.12ï¼ˆp>0.1ï¼‰
    ç»„é—´å·®å¼‚æ˜¾è‘—ï¼ˆF=12.3, p<0.01ï¼‰

    æŒ‰ä¼ä¸šè§„æ¨¡åˆ†ç»„ï¼Œå‘ç°å¤§å‹ä¼ä¸šçš„è½¬å‹æ•ˆæœæ›´æ˜¾è‘—ã€‚
    æŒ‰æ‰€æœ‰åˆ¶åˆ†ç»„ï¼Œå›½æœ‰ä¼ä¸šä¸æ°‘è¥ä¼ä¸šæ— æ˜¾è‘—å·®å¼‚ã€‚

    äº”ã€ç»“è®ºä¸å¯ç¤º

    æœ¬æ–‡å‘ç°æ•°å­—åŒ–è½¬å‹æ˜¾è‘—ä¿ƒè¿›ä¼ä¸šåˆ›æ–°ç»©æ•ˆï¼Œç»„ç»‡å­¦ä¹ èƒ½åŠ›èµ·é‡è¦ä¸­ä»‹ä½œç”¨ã€‚
    ç ”ç©¶ç»“è®ºä¸ºä¼ä¸šæ•°å­—åŒ–æˆ˜ç•¥æä¾›äº†ä»¥ä¸‹å¯ç¤ºï¼š
    1. ä¼ä¸šåº”åŠ å¤§æ•°å­—æŠ€æœ¯æŠ•å…¥ï¼Œæ¨è¿›æ•°å­—åŒ–è½¬å‹è¿›ç¨‹
    2. é‡è§†ç»„ç»‡å­¦ä¹ èƒ½åŠ›å»ºè®¾ï¼Œå®Œå–„çŸ¥è¯†ç®¡ç†ä½“ç³»
    3. é«˜æŠ€æœ¯è¡Œä¸šåº”ä¼˜å…ˆå®æ–½æ•°å­—åŒ–è½¬å‹æˆ˜ç•¥

    ç ”ç©¶å±€é™ï¼š
    1. æ•°æ®ä»…æ¶µç›–ä¸Šå¸‚å…¬å¸ï¼Œä¸­å°ä¼ä¸šæ ·æœ¬ä¸è¶³
    2. æœªè€ƒè™‘æ•°å­—åŒ–è½¬å‹çš„å¼‚è´¨æ€§è·¯å¾„
    3. æœªçº³å…¥å›½é™…åŒ–ç­‰é‡è¦è°ƒèŠ‚å˜é‡

    æœªæ¥ç ”ç©¶æ–¹å‘ï¼š
    1. æ¢è®¨ä¸åŒç±»å‹æ•°å­—æŠ€æœ¯çš„å·®å¼‚åŒ–å½±å“
    2. ç»“åˆå®éªŒæˆ–å‡†å®éªŒè®¾è®¡å¢å¼ºå› æœè¯†åˆ«
    3. é‡‡ç”¨æœºå™¨å­¦ä¹ æ–¹æ³•æŒ–æ˜éçº¿æ€§å…³ç³»
    """

    input_data = {
        "research_topic": "æ•°å­—åŒ–è½¬å‹å¯¹ä¼ä¸šåˆ›æ–°ç»©æ•ˆçš„å½±å“",
        "variable_system": "X: æ•°å­—åŒ–è½¬å‹; Y: åˆ›æ–°ç»©æ•ˆ; Z1: ç»„ç»‡å­¦ä¹ ; Z2: ç¯å¢ƒåŠ¨æ€æ€§",
        "theory_framework": "èµ„æºåŸºç¡€ç†è®ºã€ç»„ç»‡å­¦ä¹ ç†è®ºã€åŠ¨æ€èƒ½åŠ›ç†è®º",
        "model_design": "åŒå‘å›ºå®šæ•ˆåº”æ¨¡å‹",
        "data_analysis": "ç³»æ•°0.218***, ä¸­ä»‹æ•ˆåº”62%, RÂ²=0.623",
        "final_report": paper_content
    }

    print("\næ­£åœ¨æ‰§è¡Œå®Œæ•´å®¡ç¨¿æµç¨‹...")
    print("è¿™å°†åŒ…æ‹¬ï¼š")
    print("  1. LLM å®šæ€§è¯„å®¡ï¼ˆå†…ç”Ÿæ€§ã€å› æœè¯†åˆ«ã€è®ºè¯é€»è¾‘ç­‰ï¼‰")
    print("  2. AES è‡ªåŠ¨è¯„åˆ†ï¼ˆ8ä¸ªç»´åº¦çš„é‡åŒ–æŒ‡æ ‡ï¼‰")

    result = reviewer.run(input_data)

    # æ˜¾ç¤º LLM è¯„å®¡ç»“æœæ‘˜è¦
    print(f"\n{'='*70}")
    print("ğŸ“‹ LLM å®šæ€§è¯„å®¡ç»“æœ")
    print(f"{'='*70}")

    parsed_data = result.get("parsed_data", {})
    if parsed_data:
        # æ€»ä½“è¯„ä»·
        overall = parsed_data.get("overall_assessment", {})
        if overall:
            print(f"\næ€»ä½“æ°´å¹³: {overall.get('overall_level', 'N/A')}")
            print(f"å®¡ç¨¿å»ºè®®: {overall.get('recommendation', 'N/A')}")

        # å®šé‡åˆ†æ
        quant = parsed_data.get("quantitative_analysis", {})
        if quant:
            print(f"\nLLM è¯„åˆ†: {quant.get('overall_score', 'N/A')}")
            print(f"ç­‰çº§: {quant.get('grade', 'N/A')}")

    # æ˜¾ç¤º AES è¯„åˆ†ç»“æœ
    if result.get("aes_enabled"):
        print(f"\n{'='*70}")
        print("ğŸ¤– AES è‡ªåŠ¨è¯„åˆ†ç»“æœ")
        print(f"{'='*70}")

        aes_score = result.get("aes_score", {})
        print(f"\næ€»åˆ†: {aes_score.get('normalized_score', 0):.2f}/100")
        print(f"åŸå§‹åˆ†: {aes_score.get('total_score', 0):.4f}")

        print(f"\nåˆ†ç»´åº¦å¾—åˆ†:")
        print(f"\n  NLP å®šé‡æŒ‡æ ‡:")
        nlp_metrics = {
            "citation_coverage": "å¼•ç”¨è¦†ç›–ç‡",
            "causal_relevance": "å› æœç›¸å…³æ€§",
            "support_strength": "æ”¯æŒå¼ºåº¦",
            "contradiction_penalty": "çŸ›ç›¾æƒ©ç½š",
            "evidence_sufficiency": "è¯æ®å……åˆ†æ€§",
        }
        for metric, name in nlp_metrics.items():
            score = aes_score.get('dimension_scores', {}).get(metric, 0.0)
            print(f"    {name:15s}: {score:.4f}")

        print(f"\n  LLM å®šæ€§æŒ‡æ ‡ (ä» LLM è¯„å®¡æå–):")
        llm_metrics = {
            "endogeneity_quality": "å†…ç”Ÿæ€§å¤„ç†è´¨é‡",
            "methodology_rigor": "æ–¹æ³•è®ºä¸¥è°¨æ€§",
            "academic_standards": "å­¦æœ¯è§„èŒƒæ€§",
        }
        for metric, name in llm_metrics.items():
            score = aes_score.get('dimension_scores', {}).get(metric, 0.0)
            # æ˜¾ç¤ºç¦»æ•£å€¼è¯´æ˜
            if score == 1.0:
                level = "ä¼˜ç§€"
            elif score == 0.5:
                level = "è‰¯å¥½"
            else:
                level = "ä¸è¶³"
            print(f"    {name:15s}: {score:.1f} ({level})")

        print(f"\nç»Ÿè®¡ä¿¡æ¯:")
        print(f"  Claims æ€»æ•°: {aes_score.get('claims_count', 0)}")
        print(f"  Evidences æ€»æ•°: {aes_score.get('evidences_count', 0)}")
        print(f"  æœ‰è¯æ®çš„ Claims: {aes_score.get('claims_with_evidence', 0)}")

        print(f"\nClaim ç±»å‹åˆ†å¸ƒ:")
        dist = aes_score.get('detailed_analysis', {}).get('claim_type_distribution', {})
        for claim_type, count in dist.items():
            type_names = {
                "hypothesis": "å‡è®¾é™ˆè¿°",
                "conclusion": "ç»“è®ºé™ˆè¿°",
                "mechanism": "æœºåˆ¶åˆ†æ",
                "background": "èƒŒæ™¯é™ˆè¿°",
                "general": "ä¸€èˆ¬é™ˆè¿°",
            }
            name = type_names.get(claim_type, claim_type)
            print(f"  {name:12s}: {count}")

    else:
        print(f"\nâš ï¸ AES è¯„åˆ†æœªå¯ç”¨")
        if "aes_error" in result:
            print(f"é”™è¯¯ä¿¡æ¯: {result['aes_error']}")

    # ç»¼åˆåˆ†æ
    print(f"\n{'='*70}")
    print("ğŸ“Š ç»¼åˆè¯„ä»·")
    print(f"{'='*70}")

    if result.get("aes_enabled") and parsed_data:
        llm_score = quant.get('overall_score', 0) if quant else 0
        aes_total = aes_score.get('normalized_score', 0)

        print(f"\nLLM å®šæ€§è¯„åˆ†: {llm_score}/100")
        print(f"AES å®šé‡è¯„åˆ†: {aes_total:.2f}/100")

        # å¯ä»¥è®¾è®¡ä¸€ä¸ªç»¼åˆè¯„åˆ†å…¬å¼
        # ä¾‹å¦‚ï¼šç»¼åˆåˆ† = 0.6 * LLMåˆ† + 0.4 * AESåˆ†
        if isinstance(llm_score, (int, float)) and llm_score > 0:
            combined = 0.6 * llm_score + 0.4 * aes_total
            print(f"\nç»¼åˆè¯„åˆ†: {combined:.2f}/100 (LLMæƒé‡60%, AESæƒé‡40%)")


def test_save_review_results():
    """æµ‹è¯•ä¿å­˜è¯„å®¡ç»“æœ"""
    print("\n" + "=" * 70)
    print("æµ‹è¯•3: ä¿å­˜è¯„å®¡ç»“æœåˆ°æ–‡ä»¶")
    print("=" * 70)

    reviewer = ReviewerAgent(enable_aes=True)

    input_data = {
        "research_topic": "ç¢³æ’æ”¾æƒäº¤æ˜“å¯¹ä¼ä¸šç»¿è‰²åˆ›æ–°çš„å½±å“",
        "final_report": """
        å‡è®¾H1ï¼šç¢³äº¤æ˜“æ”¿ç­–ä¿ƒè¿›ä¼ä¸šç»¿è‰²åˆ›æ–°ï¼ˆPorterå‡è¯´ï¼‰ã€‚
        å®è¯ç»“æœæ˜¾ç¤ºç³»æ•°ä¸º0.31ï¼ˆp<0.01ï¼‰ï¼Œæ”¯æŒå‡è®¾ã€‚
        åŸºäº2013-2022å¹´è¯•ç‚¹çœä»½æ•°æ®ï¼ŒDIDå›å½’å‘ç°æ˜¾è‘—æ­£å‘æ•ˆåº”ã€‚
        å·²æœ‰æ–‡çŒ®æ”¯æŒè¯¥ç»“è®ºï¼ˆZhang et al., 2021; æå››ï¼Œ2020ï¼‰ã€‚
        """
    }

    result = reviewer.run(input_data)

    # ä¿å­˜åˆ° JSON æ–‡ä»¶
    import json
    from datetime import datetime

    output_dir = Path("output/reviews")
    output_dir.mkdir(parents=True, exist_ok=True)

    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    output_file = output_dir / f"review_{timestamp}.json"

    # å‡†å¤‡ä¿å­˜çš„æ•°æ®
    save_data = {
        "timestamp": timestamp,
        "research_topic": result.get("research_topic", ""),
        "llm_review": result.get("review_report", {}),
        "aes_score": result.get("aes_score", {}),
        "aes_enabled": result.get("aes_enabled", False),
    }

    with open(output_file, 'w', encoding='utf-8') as f:
        json.dump(save_data, f, ensure_ascii=False, indent=2)

    print(f"\nâœ… è¯„å®¡ç»“æœå·²ä¿å­˜: {output_file}")
    print(f"æ–‡ä»¶å¤§å°: {output_file.stat().st_size / 1024:.2f} KB")


def main():
    """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
    print("\n" + "=" * 70)
    print("ğŸš€ Reviewer Agent + AES è¯„åˆ†ç³»ç»Ÿæµ‹è¯•")
    print("=" * 70)

    try:
        # æµ‹è¯•1: åŸºç¡€å®¡ç¨¿
        test_reviewer_basic()

        # æµ‹è¯•2: å®Œæ•´å®¡ç¨¿ï¼ˆLLM + AESï¼‰
        test_reviewer_with_aes()

        # æµ‹è¯•3: ä¿å­˜ç»“æœ
        test_save_review_results()

        print("\n" + "=" * 70)
        print("âœ… æ‰€æœ‰æµ‹è¯•å®Œæˆ!")
        print("=" * 70)

    except Exception as e:
        print(f"\nâŒ æµ‹è¯•å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()